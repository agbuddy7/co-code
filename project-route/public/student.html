<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Student Coding Page</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .header {
            background: white;
            padding: 15px;
            border-radius: 5px;
            margin-bottom: 20px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }
        #studentInfo {
            font-size: 18px;
            color: #333;
        }
        #code {
            width: 100%;
            height: 500px;
            font-family: 'Courier New', monospace;
            font-size: 14px;
            border: 2px solid #ddd;
            border-radius: 5px;
            padding: 10px;
            background-color: white;
            resize: vertical;
            box-sizing: border-box;
        }
        .status {
            margin-top: 10px;
            padding: 10px;
            border-radius: 5px;
            background-color: #d4edda;
            border: 1px solid #c3e6cb;
            color: #155724;
        }
        button {
            padding: 12px 24px;
            font-size: 16px;
            background-color: #007bff;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            margin: 10px;
        }
        button:hover {
            background-color: #0056b3;
        }



        .output-box h1, .output-box h2, .output-box h3 {
            margin: 0.5em 0;
        }

        .output-box code {
            background: #eee;
            padding: 2px 4px;
            border-radius: 4px;
            font-family: monospace;
        }

        .output-box pre {
            background: #eee;
            padding: 0.5rem;
            border-radius: 6px;
            overflow-x: auto;
        }

        .output-box strong {
            font-weight: bold;
        }


        .custom-select {
            appearance: none; /* Remove default arrow */
            -webkit-appearance: none;
            -moz-appearance: none;

            background-color: #f9f9f9;
            border: 1px solid #ccc;
            padding: 0.6rem 1rem;
            border-radius: 8px;
            font-size: 1rem;
            font-family: inherit;
            color: #333;
            outline: none;
            cursor: pointer;
            background-image: url("data:image/svg+xml;charset=US-ASCII,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='12' viewBox='0 0 24 24'%3E%3Cpath fill='gray' d='M7 10l5 5 5-5z'/%3E%3C/svg%3E");
            background-repeat: no-repeat;
            background-position: right 0.75rem center;
            background-size: 1rem;
            transition: border-color 0.2s ease-in-out, box-shadow 0.2s ease-in-out;
        }

        .custom-select:hover {
            border-color: #999;
        }

        .custom-select:focus {
            border-color: #666;
            box-shadow: 0 0 0 2px rgba(100, 100, 255, 0.3);
        }


    </style>
</head>
<body>
    <div class="header">
        <div id="studentInfo">Loading...</div>
    </div>
    

<select id="language" class="custom-select">
  <option value="52">C</option>
  <option value="54">C++</option>
  <option value="62">Java</option>
  <option value="71">Python</option>
</select><br><br>


<div>
    
    <textarea id="code" placeholder="Start typing your code here..."></textarea>
</div>

<div>
    
    <button onclick="submitCode()">Run Code</button>
</div>




    
    <div class="status" id="status">Connected - Your code is being shared with the teacher in real-time</div>

    <h3>Output:</h3>

    <div id="output" class="output-box">
        <pre id="output"></pre>
    </div>


    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <script src="/socket.io/socket.io.js"></script>
    <script>

async function submitCode() {
  const code = document.getElementById("code").value;
  const languageId = document.getElementById("language").value;

  const outputElement = document.getElementById("output");
  outputElement.textContent = "Analyzing code...";

  // Get language name for better prompt
  const languageNames = {
    "52": "C",
    "54": "C++", 
    "62": "Java",
    "71": "Python"
  };
  
  const languageName = languageNames[languageId] || "Unknown";

  const prompt = `You are a code execution engine and compiler. Analyze this ${languageName} code and provide:

1. If the code has syntax errors, provide compilation error messages like a real compiler
2. If the code has logical errors, explain what's wrong and give hints
3. If the code is correct, execute it mentally and provide the expected output
4. Always be helpful and educational in your response

Language: ${languageName}
Code:
\`\`\`${languageName.toLowerCase()}
${code}
\`\`\`

Provide your response as if you are both a compiler and execution engine. If there are errors, format them clearly. If the code runs successfully, show the expected output.`;

  console.log("Analyzing code with Gemini...");
  const output = await promptGemini(prompt);
  console.log("Gemini analysis:", output);

  outputElement.innerHTML = marked.parse(output);
}




async function promptGemini(promptText) {
  const API_KEY = "AIzaSyCj1UJ66RlNYA52iGR80iiMigZzEjziwpE";

  const response = await fetch(
    `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${API_KEY}`,
    {
      method: "POST",
      headers: {
        "Content-Type": "application/json",
      },
      body: JSON.stringify({
        contents: [
          {
            parts: [{ text: promptText }]
          }
        ]
      })
    }
  );

  const data = await response.json();
  console.log("Gemini response:", data);

  if (data.candidates && data.candidates.length > 0) {
    return data.candidates[0].content.parts[0].text;
  } else if (data.error) {
    return `Gemini API error: ${data.error.message}`;
  } else {
    return "No response from Gemini.";
  }
}

        // Get student ID from URL parameters
        const urlParams = new URLSearchParams(window.location.search);
        const studentId = urlParams.get('id');
        
        if (!studentId) {
            alert('Invalid student session. Redirecting to home page.');
            window.location.href = '/';
        }
        
        // Update student info display
        document.getElementById('studentInfo').textContent = `Student ID: ${studentId}`;
        
        const socket = io();
        const codeEditor = document.getElementById('code');
        const statusDiv = document.getElementById('status');
        
        // Join as student and get current text
        socket.emit('student_join', studentId);
        
        // Receive current text when joining
        socket.on('student_current_text', (data) => {
            if (data.studentId === studentId) {
                codeEditor.value = data.text;
            }
        });
        
        // Send text updates to server
        let timeout;
        codeEditor.addEventListener('input', () => {
            clearTimeout(timeout);
            timeout = setTimeout(() => {
                socket.emit('student_text_update', {
                    studentId: studentId,
                    text: codeEditor.value
                });
            }, 300); // Debounce for 300ms
        });
        
        // Connection status updates
        socket.on('connect', () => {
            statusDiv.textContent = 'Connected - Your code is being shared with the teacher in real-time';
            statusDiv.style.backgroundColor = '#d4edda';
        });
        
        socket.on('disconnect', () => {
            statusDiv.textContent = 'Disconnected - Trying to reconnect...';
            statusDiv.style.backgroundColor = '#f8d7da';
        });
    </script>
</body>
</html>